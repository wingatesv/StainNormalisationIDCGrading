# -*- coding: utf-8 -*-
"""Create SN Dataset from Average Image.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1b393l5zw9DX-qcCFCsASMzYhlznYMiP-
"""

pip install spams

pip install staintools

# import library
import numpy as np
import os
import PIL
import tensorflow as tf
import staintools
import matplotlib.pyplot as plt
from google.colab import drive
from os import listdir
import cv2 as cv

# connect to frive
drive.mount('/content/drive')

def get_image(path):

  im = staintools.read_image(path)
  im = staintools.LuminosityStandardizer.standardize(im)
  return im

# stain normalise dataset with Macenko technique
base_path = "/content/drive/MyDrive/Wingates FYP/Dataset/Extra Dataset"
save_path = "/content/drive/MyDrive/Wingates FYP/Dataset/V3 Macenko Normalised IDC Grading Dataset"
path = "/content/drive/MyDrive/Wingates FYP/Dataset/Stain Normalised/(Most Average) Grade 0 Training SOB_B_A-14-22549AB-400-017.png"
METHOD = 'macenko'
normalizer = staintools.StainNormalizer(method=METHOD)
normalizer.fit(get_image(path))

print(f'Folder contains {len(listdir(base_path))} folders')
print(listdir(base_path))

print('')

for type_folder in listdir(base_path):
  type_path = base_path + "/" + type_folder
  print(f'In Folder :{type_path}')
  print('')

  for grade_folder in listdir(type_path):
    grade_path = type_path + "/" + grade_folder
    print(f'In Folder :{grade_path}')
    print('')

    for files in listdir(grade_path):
      image_path = grade_path + "/" + files
    
      saveim_path = save_path + "/" + type_folder  + "/" + grade_folder  
      im = staintools.read_image(image_path)
      im = staintools.LuminosityStandardizer.standardize(im)
      im = normalizer.transform(im)

      if not os.path.exists(saveim_path):
        os.makedirs(saveim_path)

        
      os.chdir(saveim_path) 
      file_name = str(files)
      cv.imwrite(file_name,im)

# stain normalise with Reinhard technique
base_path = "/content/drive/MyDrive/Wingates FYP/Dataset/Extra Dataset"
save_path = "/content/drive/MyDrive/Wingates FYP/Dataset/V3 Reinhard Normalised IDC Grading Dataset"
path = "/content/drive/MyDrive/Wingates FYP/Dataset/Stain Normalised/(Most Average) Grade 0 Training SOB_B_A-14-22549AB-400-017.png"

normalizer = staintools.ReinhardColorNormalizer()
normalizer.fit(get_image(path))

print(f'Folder contains {len(listdir(base_path))} folders')
print(listdir(base_path))
print('')

for type_folder in listdir(base_path):
  type_path = base_path + "/" + type_folder
  print(f'In Folder :{type_path}')
  print('')

  for grade_folder in listdir(type_path):
    grade_path = type_path + "/" + grade_folder
    print(f'In Folder :{grade_path}')
    print('')

    for files in listdir(grade_path):
      image_path = grade_path + "/" + files
    
      saveim_path = save_path + "/" + type_folder  + "/" + grade_folder  
      im = staintools.read_image(image_path)
      im = staintools.LuminosityStandardizer.standardize(im)
      im = normalizer.transform(im)

      if not os.path.exists(saveim_path):
        os.makedirs(saveim_path)

        
      os.chdir(saveim_path) 
      file_name = str(files)
      cv.imwrite(file_name,im)